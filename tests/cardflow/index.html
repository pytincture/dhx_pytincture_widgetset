<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>CardFlow Expand Test Harness</title>
    <link rel="stylesheet" href="../../dhxpyt/dhxsrc/suite.css">
    <link rel="stylesheet" href="../../dhxpyt/dhxsrc/dhx_custom.css">
    <style>
        html, body {
            margin: 0;
            height: 100%;
            font-family: Arial, sans-serif;
            background: #f7f8fa;
        }

        #app {
            height: 100%;
            width: 100%;
        }

        #controls {
            position: fixed;
            top: 10px;
            right: 10px;
            display: flex;
            gap: 8px;
            z-index: 1000;
        }

        #controls button {
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            background: #4c6ef5;
            color: #fff;
            font-size: 13px;
            cursor: pointer;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.15);
        }

        #controls button:active {
            transform: translateY(1px);
        }

        #log {
            position: fixed;
            bottom: 10px;
            left: 10px;
            max-height: 200px;
            width: 320px;
            overflow-y: auto;
            font-size: 12px;
            background: rgba(255, 255, 255, 0.95);
            border: 1px solid #d0d4da;
            border-radius: 6px;
            padding: 10px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.08);
        }

        #log h2 {
            margin: 0 0 8px;
            font-size: 13px;
            color: #3a4b6b;
        }

        #log ul {
            margin: 0;
            padding-left: 18px;
        }

        #log li {
            margin-bottom: 4px;
        }
    </style>
</head>
<body>
    <div id="app"></div>
    <div id="controls">
        <button id="expand-all">Expand All</button>
        <button id="collapse-all">Collapse All</button>
    </div>
    <div id="log">
        <h2>Event Log</h2>
        <ul id="log-items"></ul>
    </div>

    <script src="../../dhxpyt/dhxsrc/suite.js"></script>
    <script src="../../dhxpyt/dhxsrc/cardflow.js"></script>
    <script>
        function log(message) {
            const logItems = document.getElementById("log-items");
            const entry = document.createElement("li");
            entry.textContent = `${new Date().toLocaleTimeString()} — ${message}`;
            logItems.prepend(entry);
            // Limit history to the most recent 15 entries
            while (logItems.children.length > 15) {
                logItems.removeChild(logItems.lastChild);
            }
        }

        document.addEventListener("DOMContentLoaded", () => {
            const layout = new dhx.Layout("app", {
                cols: [{
                    header: "CardFlow Test Area",
                    css: "dhx_widget--bordered",
                    padding: 10,
                    id: "cardflow-cell"
                }]
            });

            const container = layout.getCell("cardflow-cell");

            const cardflowConfig = {
                sortHeader: "<strong>Sort Cards</strong>",
                columns: [
                    { id: "name", header: "Name", width: "180px" },
                    { id: "status", header: "Status", width: "120px" },
                    { id: "priority", header: "Priority", width: "110px" },
                    { id: "promise_time", header: "Promise Time", width: "140px", dataType: "time", dataFormat: "HH:MM AM/PM", applyFormat: true },
                    { type: "stretch" }
                ],
                data: [
                    { id: "order-101", name: "Order 101", status: "In Progress", priority: "High", promise_time: "09:30 AM" },
                    { id: "order-102", name: "Order 102", status: "Queued", priority: "Medium", promise_time: "01:15 PM" },
                    { id: "order-103", name: "Order 103", status: "Delayed", priority: "High", promise_time: "11:45 AM" },
                    { id: "order-104", name: "Order 104", status: "Complete", priority: "Low", promise_time: "03:20 PM" }
                ],
                optionItems: [
                    { id: "details", value: "View Details" },
                    { id: "reassign", value: "Reassign" },
                    { id: "cancel", value: "Cancel Order" }
                ],
                defaultExpandedHeight: "260px",
                fontSize: "13px"
            };

            const cardflow = new customdhx.CardFlow(container, cardflowConfig);
            window.cardflow = cardflow;

            cardflow.onExpand = (cardId) => log(`Card expanded: ${cardId}`);
            cardflow.onCollapse = (cardId) => log(`Card collapsed: ${cardId}`);
            cardflow.onOptions = (cardId, _event, value) => log(`Options for ${cardId} → ${value}`);

            document.getElementById("expand-all").addEventListener("click", () => {
                cardflow.expandAll();
                log("expandAll() invoked");
            });

            document.getElementById("collapse-all").addEventListener("click", () => {
                cardflow.collapseAll();
                log("collapseAll() invoked");
            });

            // Build a nested DHTMLX layout to mimic the real workflow detail view.
            const buildDetailWidget = (id) => {
                const detailLayout = new dhx.Layout(null, {
                    rows: [
                        {
                            id: "header",
                            height: "content",
                            css: "dhx_widget--bordered",
                            html: `<div style="padding:12px;">
                                <h3 style="margin:0;">Details for ${id.toUpperCase()}</h3>
                                <p style="margin:6px 0 0; color:#51617d;">This simulates the Baylogic detail layout.</p>
                            </div>`
                        },
                        {
                            id: "content",
                            css: "dhx_widget--bordered",
                            html: `<div style="padding:12px; line-height:1.5; color:#2f3e55;">
                                <strong>Work description</strong>
                                <p>Lorem ipsum dolor sit amet, consectetur adipiscing elit. Nulla vitae sem ut justo suscipit auctor.</p>
                                <p>Ut euismod, libero id semper pretium, lorem orci blandit justo, ac varius neque sapien sed urna.</p>
                            </div>`
                        }
                    ]
                });
                return detailLayout;
            };

            ["order-101", "order-102", "order-103", "order-104"].forEach((id, index) => {
                const detailWidget = buildDetailWidget(id);
                cardflow.attachToCardContent(id, detailWidget);
                cardflow.setCardExpandedHeight(id, `${240 + index * 20}px`);
            });

            // By default show collapsed state, but allow quick manual testing.
            log("CardFlow test harness initialized");
        });
    </script>
</body>
</html>
